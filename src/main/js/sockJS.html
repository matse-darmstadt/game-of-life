<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta charset="utf-8" />
<title>jQuery autocomplete with SockJS</title>
<link rel="stylesheet"
	href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />

<script src="http://cdn.sockjs.org/sockjs-0.3.min.js"></script>
<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>

<script>
	// SOCKJS_PROXY = 'http://134.93.130.181';
	SOCKJS_PROXY = 'http://localhost:1234';
	
	TIMEOUT = 10000; // ms after the last AC request the socket will be closed
	

	sockIsOpen = false;
	var sock;

	function onSocketOpen() {
		sockIsOpen = true;
		console.log('Socket opened');
		
		// Send Index of the current session
		console.log('Sending index');
		sock.send("12345678");
	};
	
	function openSocket() {
		sock = new SockJS(SOCKJS_PROXY);
		
		sock.onopen = onSocketOpen;
		
		sock.onclose = function() {
			sockIsOpen = false;
			console.log('Socket closed');
		};
		resetSocketTimeout();
	}

	function resetSocketTimeout() {
		clearTimeout(this.timeout);
		this.timeout = setTimeout(function() {
			console.log('Closing socket');
			sock.close();
		}, TIMEOUT);
	}

	function openSocketIfClosed() {
		if (!sockIsOpen) {
			openSocket();
		}
	}

	function ACHandler(request, ac_response) {
		console.log("AC request:" + request.term);

		sock.send(request.term);

		sock.onmessage = function(e) {
			if(e.data){
				console.log("Server answer:" + e.data);
				DATA = JSON.parse(e.data)
				ac_data = $.map(DATA.suggestionList, function(suggestItem) {
					return {
						label : suggestItem[0],
						payload : JSON.parse(suggestItem[1])
					}
				});
				ac_response(ac_data);
			}
		};
	};

	$(document).ready(function() {
		// Global Variables
		input = $("#in");

		/*
		 * Open the socket whenever the user clicks the input or moves the
		 * cursor over it
		 */
		input.focus(openSocketIfClosed);
		input.mouseover(openSocketIfClosed)

		input.autocomplete({
			delay : 0, // no delay
			source : function(request, ac_response) {
				if (!sockIsOpen) {
					console.log('Openning socket');
					openSocket();
					sock.onopen = function() {
						onSocketOpen();
						ACHandler(request, ac_response);
					};
				} else {
					resetSocketTimeout();
					ACHandler(request, ac_response);
				}
			},
			
			select:  function(event, row){  
				if(row.item.payload.href.startsWith("http")){
					location.href =  row.item.payload.href;
				} else {
					location.href = "http://"+row.item.payload.href;
				}
            }
		/*
		 * Set the render engine
		 */
		}).data("ui-autocomplete")._renderItem = function( ul, item ) {
			var innerHTML = '<a><div class = "list_item_container" style="width:500px;"><div style="float:left; width:120px;"><img src="'+item.payload.img+'"></div><div style="float:left; width:300px; margin:8px; padding:8px;">' + item.label  +  '</div></div><br style="clear:both;"></a>';
			return $( "<li></li>" )
            	.data( "item.autocomplete", item )
            	.append( innerHTML )
            	.appendTo( ul );
    };
	});
</script>

</head>
<body>
	<h1>SockJs AutoComplete</h1>

	<div class="ui-widget">
        <form>
		  <label for="in"> Search: </label> <input id="in" />
        </form>
	</div>
</body>
</html>
